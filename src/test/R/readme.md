### Test framework version

Test framework created using:

| RiaH version | RiaH mapping specs file |
| --- | --- |
| vX.X.X | `<file name>.json.gz` (last updated: XX/XX/XXXX) |

### How to run the tests

Assuming the test framework is already in place (see next section), you can execute existing tests as follows:

1. Install R with the packages `yaml` and `DatabaseConnector`.
2. Rename `config-sample.yml` to `config.yml` and update it with your local settings. The target schema should match the one containing the project-specific tables.
3. Run `run_create_tests.R` to generate the test data.
4. Execute the ETL, using the data generated by the test framework as source data (i.e. the `sourceDataDir` in `config.yml`), and the same connection details as specified in `config.yml`.
5. Run `run_evaluate_tests.R` to obtain a report of the test results.

You can run the R scripts in the terminal from this folder using `R -f <script_name>.R`.

### How to implement new tests

#### Test Framework creation

The first step is the creation of `TestFramework.R` using the 
[Rabbit in a Hat test framework functionality](http://ohdsi.github.io/WhiteRabbit/riah_test_framework.html#creating_the_testing_framework).
You only need to repeat this step in case of significant changes to the original mappings 
(alternativaly, you could edit `TestFramework.R` manually to introduce new default values or constraints).

Note that the automatically generated test framework **won't contain any custom tables**; 
to be able to test these, you will have to add them yourself. `TestFramework-placeholder.R`
contains an example of custom code to enable testing of the `TreatmentLine` table.
You can copy over the content of this file to `TestFramework.R` as needed, and safely remove it.

#### Implementing individual test cases

New tests should be added to the correct file in the `test_cases` folder.
The convention is to have **one file per source file / target CDM table combination**, as for the transformation scripts.
You will then need to `source()` these scripts in `run_create_tests.R`;
the file `test_sample_source_table_to_person.R` is provided as an example.

Available test functions are described in the [RiaH test framework documentation](http://ohdsi.github.io/WhiteRabbit/riah_test_framework.html).

In each of the `test_cases` script, the following conventions apply:
1. Give each test a **numerical ID** in within a script-specific range (see the table below); 
this helps to quickly identify the source file and target table combination when evaluating test results.

    **(NOTE: Please update the table with the actual test script names and test ID ranges for your project).**
  
2. Create a **new person for each test** to isolate the tests from each other. 
  As the person_id, use the ID of the test it belongs to: e.g. test ID `2201` = person_id `2201`. 
  This helps to identify the OMOP records related to a specific (failed) test.
  This convention should also be used for other numerical variables whenever applicable.


Here is an overview of test ID ranges for each test file:

| Test file name | Test ID range |
| --- | --- |
| test_source1_to_person.R | 1-99 |
| test_source2_to_care_site.R | 100-199 |
| test_source3_to_death.R | 200-299 |
| test_source4_to_observation.R | 300-399 |
| test_source5_to_visit_occurrence.R | 400-499 |
| test_source6_to_measurement.R | 500-599 |
| test_source7_to_drug_exposure.R | 600-699 |
| test_source8_to_condition_occurrence.R | 700-799 |
| test_source9_to_procedure_occurrence.R | 800-899 |
| test_source10_to_fact_relationship.R | 900-999 |
| test_source11_to_treatment_line.R | 1000-1099 |
| test_observation_period.R | 1100-1199 |

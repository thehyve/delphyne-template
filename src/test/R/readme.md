## Test framework version

Test framework created using:

| RiaH version | RiaH mapping specs file |
| --- | --- |
| vX.X.X | `<file name>.json.gz` (last updated: XX/XX/XXXX) |

## How to run the tests

Assuming the test framework is already in place (see next section), you can execute existing tests as follows:

1. Install R with the packages `yaml` and `DatabaseConnector`.
2. Rename `config-sample.yml` to `config.yml` and update it with your local settings. The target schema should match the one containing the project-specific tables.
3. Run `run_create_tests.R` to generate the test data.
4. Execute the ETL, using the data generated by the test framework as source data (i.e. the `sourceDataDir` in `config.yml`), and the same connection details as specified in `config.yml`.
5. Run `run_evaluate_tests.R` to obtain a report of the test results.

You can run the R scripts in the terminal from this folder using `R -f <script_name>.R`.

## How to implement new tests

### Test Framework creation

Follow the instructions to create a test framework using the 
[Rabbit in a Hat test framework functionality](http://ohdsi.github.io/WhiteRabbit/riah_test_framework.html#creating_the_testing_framework).
Rename the file `TestFramework.R` and place it in this folder (`test/R/`).
You only need to repeat this step in case of significant changes to the original mappings - alternatively, you could edit `TestFramework.R` manually to introduce new default values or constraints.

Note that the automatically generated test framework **won't contain any custom target tables**; 
to be able to test these, you must define any table-related functions yourself, and `source()` the corresponding script in `run_create_tests.R`. You should place custom table scripts in the `custom_tables` folder, using a separate file for each custom table. `TreatmentLine.R`
is provided as an example.

### Implementing individual test cases

New tests should be defined in the `test_cases` folder.
The convention is to have **one test file per source table / target table combination**, as for the transformation scripts (ideally, it should have the same file name).
You will then need to `source()` these scripts one by one in `run_create_tests.R`;
the file `test_sample_source_1_to_person.R` is provided as an example.

Available test functions are described in the [RiaH test framework documentation](http://ohdsi.github.io/WhiteRabbit/riah_test_framework.html).

In each `test_cases` script, the following conventions apply:
1. Give each test a **numerical ID within a file-specific range** (see table below); 
this helps to quickly identify the source - target table combination when evaluating test results.

2. Create a **new person for each test** within the test definition itself (rather than in the test script for the Person table) to isolate the tests from each other. 
As the person_id, use the ID of the test it belongs to, e.g. test ID `2201` -> person_id `2201`. This helps to identify the records related to a specific (failed) test.
This convention should be used for other numerical variables whenever applicable.


#### Table: overview of test ID ranges for each test script.

**(NOTE: Please update the provided table with the actual test script names and ID ranges for your project).**

| Test file name | Test ID range |
| --- | --- |
| test_sample_source_1_to_person.R | 1-99 |
| test_sample_source_2_to_care_site.R | 100-199 |
| test_sample_source_3_to_death.R | 200-299 |
| test_sample_source_4_to_observation.R | 300-399 |
| test_sample_source_5_to_visit_occurrence.R | 400-499 |
| test_sample_source_6_to_measurement.R | 500-599 |
| test_sample_source_7_to_drug_exposure.R | 600-699 |
| test_sample_source_8_to_condition_occurrence.R | 700-799 |
| test_sample_source_9_to_procedure_occurrence.R | 800-899 |
| test_sample_source_10_to_fact_relationship.R | 900-999 |
| test_sample_source_11_to_treatment_line.R | 1000-1099 |
| test_observation_period.R | 1100-1199 |

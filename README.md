# ohdsi-etl-master-template
An ORM-based ETL template for future OHDSI projects.
Provides a standard repository structure that complements the functionality of the [omop-etl-wrapper](https://github.com/thehyve/omop-etl-wrapper) package.

NOTE: Currently supports PostgreSQL only.

## Repository overview

### `root/` folder
- `main.py` triggers the ETL execution. Requires minimal customization of e.g. default connection arguments and pipeline version info.
- `README-sample.md` provides a basic README file for the project, including instructions on how to run the ETL.
Use it to **replace this readme** after completing the initial ETL setup.
- `requirements.txt` should contain project-specific ETL dependencies. It is **highly recommended** to pin packages to a specific version.
`ohdsi-etl-wrapper` is a mandatory dependency and is always included by default.
- `logging.yml` provides customized logging.

### `docs/` folder
Project documentation folder. It is recommended to place here the markdown version of the mapping specifications generated by Rabbit in a Hat 
and use it as a source for the repository's [github pages site](https://help.github.com/en/github/working-with-github-pages/creating-a-github-pages-site).

### `preprocessing/` folder
Contains a collection of scripts that are meant to be **executed independently** from the ETL.
Examples of intended uses are data exploration and cleanup, the preparation of mapping tables, and the generation of reports.
Feel free to add more, and make sure to remove any unused script before the ETL is finalized.

### `resources/` folder
Meant to contain data used by the ETL, such as mapping tables and custom vocabularies, as well as source data for E2E tests.
Unit test data should not be placed in this folder, but under `src/test/`.

Folder structure conventions:
- `custom_vocabularies` should contain project-specific vocabularies, if any. Remove this folder if not used.
- `mapping_tables` collects the mappings of project-specific variables and values to standard OMOP concept_ids. 
The mapping tables should adopt an **Usagi-compatible format** whenever possible.
- `synthetic_data` should contain data for E2E tests, generated with the Rabbit in a Hat functionality.  

### `src/main/` folder
Contains the main ETL code. The folder should be structured as follows; code examples are provided within each subfolder.

Under `python/`:
- `cdm_custom` collects any custom tables  needed in the project that are not part of an official OMOP CDM release. 
`TreatmentLine` is provided as an example.
- `transformation/` collects the project-specific transformation scripts for each source data table - target CDM table combination.
The scripts must follow the mapping specifications closely, and vice-versa the mapping specifications must reflect any implementation decision made in the scripts.
- `util/` should contain any functions or classes needed in the transformation scripts that is not already available in the repository dependencies. 
An example is the implementation of project-specific VariableConceptMapper subclasses. 
- `wrapper.py` specifies the order of operations executed during each ETL run. 
Add project-specific scripts from the `transformation/` and `sql/` folders to the `run()` method to have them executed by the pipeline.

Under `sql/`:
- place here any (Postgre)SQL-based transformation scripts.

### `src/test/` folder
The `R/` folder contains unit tests based on a test framework automatically generated by Rabbit in a Hat.
See `readme.md` in the folder for details on how to build and use the framework.

*A future template release will replace the R framework with Python-based unit tests for better integration with GitHub workflows.*


